<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Budget Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better font and potentially other overrides */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ensure input type="date" looks consistent */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5); /* Adjust color if needed */
        }
        /* Custom background color */
        .bg-light-sandy-brown {
            background-color: #E5D2B8; /* A light tan/brown from the screenshot */
        }
        .bg-sidebar-light {
            background-color: #D4C2A9; /* A slightly darker beige for the sidebar */
        }
    </style>
</head>
<body class="min-h-screen flex items-stretch font-inter bg-light-sandy-brown">
    <div id="app-container" class="flex flex-1 min-h-screen">
        <aside id="main-sidebar" class="w-20 lg:w-1/6 bg-sidebar-light flex flex-col items-center py-8 shadow-lg flex-shrink-0">
            <div class="mb-10 text-center">
                <span class="text-2xl font-bold text-gray-800">F/B</span>
                <div class="text-xs text-gray-600">Mindanao</div>
            </div>

            <div class="space-y-6 w-full px-2">
                <button id="nav-dashboard-btn" class="flex flex-col items-center justify-center p-3 rounded-lg w-full transition duration-200 ease-in-out hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="w-8 h-8 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0v-6a1 1 0 011-1h2a1 1 0 011 1v6m-6 0h6"></path>
                    </svg>
                    <span class="text-xs text-gray-700 mt-1">Home</span>
                </button>

                <button id="nav-expenses-btn" class="flex flex-col items-center justify-center p-3 rounded-lg w-full transition duration-200 ease-in-out hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="w-8 h-8 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M17 16l-4 4m-4-4l4 4"></path>
                    </svg>
                    <span class="text-xs text-gray-700 mt-1">GAA</span>
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col">
            <header class="bg-white p-4 shadow-md flex items-center justify-between flex-shrink-0">
                <div class="flex items-center">
                    <span class="text-2xl font-bold text-gray-800">F/B</span>
                    <div class="text-xs text-gray-600 ml-1">Mindanao</div>
                </div>
                <h1 class="text-3xl font-extrabold text-gray-800 text-center flex-1">BUDGET TRACKER SYSTEM</h1>
                <div class="w-16"></div>
            </header>

            <main id="dynamic-content-area" class="flex-1 p-8 overflow-y-auto">
                </main>
        </div>
    </div>

    <script>
        // --- Global State Variables ---
        let annualIncome = '';
        let recordedExpenses = []; // Stores { id, name, amount, date, quarter }
        let currentView = 'dashboard'; // 'dashboard', 'quarterDetails', or 'allExpenses'
        let selectedQuarterId = null; // 'Q1', 'Q2', etc. when currentView is 'quarterDetails'

        // --- Data for the Fund Dashboard Table (now dynamic) ---
        let fundData = [
            {
                id: 1,
                expenseItem: 'Travelling Expenses (Local)',
                accountCode: '50201010-00-001',
                q1: 0.00,
                q2: 40000.00,
                q3: 40000.00,
                q4: 0.00,
                obligated: 0.00,
                status: 'Not Utilized'
            },
            {
                id: 2,
                expenseItem: 'Training Expenses',
                accountCode: '50202010-00-001',
                q1: 25000.00,
                q2: 25000.00,
                q3: 25000.00,
                q4: 25000.00,
                obligated: 0.00,
                status: 'Under Utilization'
            },
            {
                id: 3,
                expenseItem: 'Office Supplies Expenses',
                accountCode: '50203010-00-001',
                q1: 20000.00,
                q2: 0.00,
                q3: 0.00,
                q4: 0.00,
                obligated: 0.00,
                status: 'Utilized'
            },
            {
                id: 4,
                expenseItem: 'Other Supplies and Materials Expenses',
                accountCode: '50203990-00-001',
                q1: 210000.00,
                q2: 0.00,
                q3: 0.00,
                q4: 0.00,
                obligated: 0.00,
                status: 'Utilized'
            },
            {
                id: 5,
                expenseItem: 'Representation Expenses',
                accountCode: '50299030-00-001',
                q1: 3000.00,
                q2: 3000.00,
                q3: 3000.00,
                q4: 3000.00,
                obligated: 0.00,
                status: 'Under Utilization'
            },
            {
                id: 6,
                expenseItem: 'Other MOOE',
                accountCode: '50299990-99-001',
                q1: 50000.00,
                q2: 0.00,
                q3: 0.00,
                q4: 0.00,
                obligated: 0.00,
                status: 'Utilized'
            }
        ];

        // --- Utility Functions ---

        // Formats currency to Philippine Peso (₱)
        function formatCurrency(amount) {
            return `₱${parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Calculates total expenses across all quarters
        function calculateTotalExpenses() {
            return recordedExpenses.reduce((sum, expense) => {
                const amount = parseFloat(expense.amount) || 0;
                return sum + amount;
            }, 0);
        }

        // Calculates remaining balance (Annual Income - Total Expenses)
        function calculateRemainingBalance() {
            const income = parseFloat(annualIncome) || 0;
            return income - calculateTotalExpenses();
        }

        // Calculates the budget for each quarter (even split)
        function calculateQuarterlyBudget() {
            return annualIncome ? (parseFloat(annualIncome) / 4) : 0;
        }

        // --- Event Handlers ---

        function handleIncomeChange(event) {
            const value = event.target.value;
            // Allow only numbers and a single decimal point
            if (/^\d*\.?\d*$/.test(value) || value === '') {
                annualIncome = value;
                // DO NOT call renderApp() here on every input to allow smooth typing
            }
        }

        /**
         * Handles adding a new expense.
         * @param {string|null} quarter - The quarter ID ('Q1', 'Q2', etc.) or null for general expenses.
         * @param {string} name - The name of the expense.
         * @param {string} amount - The amount of the expense (as a string).
         * @param {string} date - The date of the expense.
         */
        function handleAddExpense(quarter, name, amount, date) {
            // Check if all fields are filled before proceeding
            if (name.trim() === '' || amount.trim() === '' || date.trim() === '') {
                console.error("Please fill in all expense fields.");
                // Optionally, provide user feedback in the UI instead of just console error
                return;
            }

            const newExpense = {
                id: Date.now(), // Unique ID for the expense
                name: name,
                amount: parseFloat(amount),
                date: date,
                quarter: quarter, // Assign the quarter if provided
            };

            recordedExpenses.push(newExpense);

            // Clear form inputs after adding
            // These global vars are now primarily for initial rendering if needed,
            // but the DOM inputs are cleared explicitly below.
            quarterNewExpenseName = '';
            quarterNewExpenseAmount = '';
            quarterNewExpenseDate = '';

            renderApp(); // Re-render the app to reflect changes
        }

        function handleRemoveExpense(id) {
            recordedExpenses = recordedExpenses.filter((expense) => expense.id !== id);
            renderApp(); // Re-render the app to reflect changes
        }

        /**
         * Adds a new row to the fundData table.
         */
        function addFundRow() {
            const newId = fundData.length > 0 ? Math.max(...fundData.map(item => item.id)) + 1 : 1;
            const newRow = {
                id: newId,
                expenseItem: 'New Expense Item',
                accountCode: 'N/A',
                q1: 0.00,
                q2: 0.00,
                q3: 0.00,
                q4: 0.00,
                obligated: 0.00,
                status: 'Not Utilized'
            };
            fundData.push(newRow);
            renderApp(); // Re-render to show the new row
        }
         /**
         * Deletes a row from the fundData table.
         * @param {number} id - The ID of the row to delete.
         */
        function deleteFundRow(id) {
            fundData = fundData.filter(item => item.id !== id);
            renderApp(); // Re-render to remove the row
        }
        // --- Rendering Functions ---

        /**
         * Renders the navigation bar.
         */
        function renderNavigation() {
            const navDashboardBtn = document.getElementById('nav-dashboard-btn');
            const navExpensesBtn = document.getElementById('nav-expenses-btn'); // Get the expenses button

            // Reset classes
            navDashboardBtn.className = 'flex flex-col items-center justify-center p-3 rounded-lg w-full transition duration-200 ease-in-out hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500';
            navExpensesBtn.className = 'flex flex-col items-center justify-center p-3 rounded-lg w-full transition duration-200 ease-in-out hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500';

            // Apply active state based on currentView
            if (currentView === 'dashboard' && selectedQuarterId === null) {
                navDashboardBtn.classList.add('bg-gray-300'); // Active state for dashboard
            } else if (currentView === 'allExpenses') { // Apply active state for expenses
                navExpensesBtn.classList.add('bg-gray-300');
            }
            // The reports button is removed, so no active state for it.

            // Attach event listeners (ensure they are attached only once or re-attached safely)
            navDashboardBtn.onclick = () => {
                currentView = 'dashboard';
                selectedQuarterId = null;
                renderApp();
            };
            navExpensesBtn.onclick = () => { // Click handler for expenses button
                currentView = 'allExpenses';
                selectedQuarterId = null;
                renderApp();
            };
        }


        /**
         * Renders the Quarter Details View.
         * @param {string} quarterId - The ID of the quarter to display (e.g., 'Q1').
         */
        function renderQuarterDetailsView(quarterId) {
            const dynamicContentArea = document.getElementById('dynamic-content-area');
            dynamicContentArea.innerHTML = ''; // Clear existing content

            const quarterlyBudget = calculateQuarterlyBudget();
            const quarterExpenses = recordedExpenses.filter(expense => expense.quarter === quarterId);
            const quarterTotalExpenses = quarterExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const quarterRemainingBalance = quarterlyBudget - quarterTotalExpenses;

            const quarterNames = {
                'Q1': 'Quarter 1 (January-March)',
                'Q2': 'Quarter 2 (April-June)',
                'Q3': 'Quarter 3 (July-September)',
                'Q4': 'Quarter 4 (October-December)',
            };

            const quarterDetailsDiv = document.createElement('div');
            quarterDetailsDiv.className = 'flex-1 p-6 bg-blue-50 rounded-xl shadow-inner border border-blue-200';
            quarterDetailsDiv.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">
                    ${quarterNames[quarterId]} Budget Details
                </h2>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                    <div class="bg-blue-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                        <div class="text-xl font-semibold">Quarterly Budget</div>
                        <div class="text-3xl font-bold">${formatCurrency(quarterlyBudget)}</div>
                    </div>
                    <div class="bg-red-600 text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                        <div class="text-xl font-semibold">Quarter Expenses</div>
                        <div class="text-3xl font-bold">${formatCurrency(quarterTotalExpenses)}</div>
                    </div>
                    <div class="${quarterRemainingBalance >= 0 ? 'bg-teal-500' : 'bg-red-500'} text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                        <div class="text-xl font-semibold">Remaining Budget</div>
                        <div class="text-3xl font-bold">${formatCurrency(quarterRemainingBalance)}</div>
                    </div>
                </div>

                <div class="mb-8 p-6 bg-green-100 rounded-xl shadow-sm border border-green-200">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">Add Expense for ${quarterId}</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="expense-title-q" class="block text-lg font-medium text-gray-700 mb-1">Expense Title:</label>
                            <input
                                type="text"
                                id="expense-title-q"
                                placeholder="e.g., Electricity Bill"
                                class="w-full p-3 border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-lg font-medium text-gray-700"
                            />
                        </div>
                        <div>
                            <label for="expense-amount-q" class="block text-lg font-medium text-gray-700 mb-1">Amount:</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-600 text-lg font-bold">₱</span>
                                <input
                                    type="text"
                                    id="expense-amount-q"
                                    placeholder="e.g., 200"
                                    class="w-full pl-8 pr-4 py-3 border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-lg font-medium text-gray-700"
                                />
                            </div>
                        </div>
                        <div>
                            <label for="expense-date-q" class="block text-lg font-medium text-gray-700 mb-1">Date:</label>
                            <input
                                type="date"
                                id="expense-date-q"
                                class="w-full p-3 border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-lg font-medium text-gray-700"
                            />
                        </div>
                        <button
                            id="add-quarter-expense-btn"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                        >
                            Add Expense to ${quarterId}
                        </button>
                    </div>
                </div>

                <div class="p-6 bg-purple-100 rounded-xl shadow-sm border border-purple-200">
                    <h3 class="text-2xl font-bold text-purple-800 mb-4">Expense History for ${quarterId}</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-purple-200 text-purple-800 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Expense Name</th>
                                    <th class="py-3 px-6 text-left">Amount</th>
                                    <th class="py-3 px-6 text-left">Date</th>
                                    <th class="py-3 px-6 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="quarter-expense-history-tbody" class="text-gray-700 text-lg font-medium">
                                </tbody>
                        </table>
                    </div>
                </div>
            `;
            dynamicContentArea.appendChild(quarterDetailsDiv);

            // --- Attach Event Listeners for Quarter Details View ---
            const expenseTitleQInput = document.getElementById('expense-title-q');
            const expenseAmountQInput = document.getElementById('expense-amount-q');
            const expenseDateQInput = document.getElementById('expense-date-q');
            const addQuarterExpenseBtn = document.getElementById('add-quarter-expense-btn');

            // Add keydown listener for Enter key on inputs
            expenseTitleQInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    // Pass current input values directly to handleAddExpense
                    handleAddExpense(quarterId, expenseTitleQInput.value, expenseAmountQInput.value, expenseDateQInput.value);
                    // Explicitly clear inputs after adding
                    expenseTitleQInput.value = '';
                    expenseAmountQInput.value = '';
                    expenseDateQInput.value = '';
                    e.preventDefault(); // Prevent default Enter key behavior (e.g., form submission)
                }
            });
            expenseAmountQInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    // Pass current input values directly to handleAddExpense
                    handleAddExpense(quarterId, expenseTitleQInput.value, expenseAmountQInput.value, expenseDateQInput.value);
                    // Explicitly clear inputs after adding
                    expenseTitleQInput.value = '';
                    expenseAmountQInput.value = '';
                    expenseDateQInput.value = '';
                    e.preventDefault();
                }
            });
            expenseDateQInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    // Pass current input values directly to handleAddExpense
                    handleAddExpense(quarterId, expenseTitleQInput.value, expenseAmountQInput.value, expenseDateQInput.value);
                    // Explicitly clear inputs after adding
                    expenseTitleQInput.value = '';
                    expenseAmountQInput.value = '';
                    expenseDateQInput.value = '';
                    e.preventDefault();
                }
            });


            addQuarterExpenseBtn.addEventListener('click', () => {
                handleAddExpense(quarterId, expenseTitleQInput.value, expenseAmountQInput.value, expenseDateQInput.value);
                // Explicitly clear inputs after adding
                expenseTitleQInput.value = '';
                expenseAmountQInput.value = '';
                expenseDateQInput.value = '';
            });

            // Populate Quarter Expense History Table
            const quarterExpenseHistoryTbody = document.getElementById('quarter-expense-history-tbody');
            if (quarterExpenses.length === 0) {
                quarterExpenseHistoryTbody.innerHTML = `
                    <tr>
                        <td colSpan="4" class="py-4 px-6 text-center text-gray-500">No expenses recorded for this quarter yet.</td>
                    </tr>
                `;
            } else {
                quarterExpenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap">${expense.name}</td>
                        <td class="py-3 px-6 text-left whitespace-nowrap">${formatCurrency(expense.amount)}</td>
                        <td class="py-3 px-6 text-left whitespace-nowrap">${expense.date}</td>
                        <td class="py-3 px-6 text-center">
                            <button
                                class="remove-expense-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-sm"
                                data-id="${expense.id}"
                                aria-label="Remove ${expense.name}"
                            >
                                Remove
                            </button>
                        </td>
                    `;
                    quarterExpenseHistoryTbody.appendChild(row);
                });
                // Attach event listeners to newly created remove buttons
                quarterExpenseHistoryTbody.querySelectorAll('.remove-expense-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        handleRemoveExpense(parseInt(e.target.dataset.id));
                    });
                });
            }
        }

        /**
         * Renders the Main Dashboard View.
         */
        function renderMainDashboard() {
            const dynamicContentArea = document.getElementById('dynamic-content-area');
            dynamicContentArea.innerHTML = ''; // Clear existing content

            const totalExpenses = calculateTotalExpenses();
            const remainingBalance = calculateRemainingBalance();
            const quarterlyBudget = calculateQuarterlyBudget();

            const dashboardContent = document.createElement('div');
            // Changed from flex-row to flex-col to stack elements vertically
            dashboardContent.className = 'w-full flex flex-col gap-8';
            dashboardContent.innerHTML = `
                <div class="p-6 bg-brown-1000 rounded-xl shadow-inner border border-brown-500">
                    <h2 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">BUDGET TRACKER SYSTEM</h2>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white text-black p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                            <div class="text-xl font-semibold">Annual Budget</div>
                            <div class="text-3xl font-bold">${formatCurrency(annualIncome || 0)}</div>
                        </div>
                        <div class="bg-white text-black p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                            <div class="text-xl font-semibold">Remaining Balance</div>
                            <div class="text-3xl font-bold">${formatCurrency(remainingBalance)}</div>
                        </div>
                        <div class="bg-white text-black p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
                            <div class="text-xl font-semibold">Total Expenses</div>
                            <div class="text-3xl font-bold">${formatCurrency(totalExpenses)}</div>
                        </div>
                    </div>

                    <div class="mb-8 p-4 bg-gray-200 rounded-lg shadow-sm">
                        <label for="annual-income" class="block text-xl font-semibold text-black-800 mb-2">
                            Set Annual Income:
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-600 text-xl font-bold">₱</span>
                            <input
                                type="text"
                                id="annual-income"
                                value="${annualIncome}"
                                placeholder="e.g., 100000"
                                class="w-full pl-8 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-xl font-medium text-gray-700"
                            />
                        </div>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-700 mb-4 text-center">Current Budget in each Quarter</h3>
                    <div id="quarter-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        </div>
                </div>

                <div class="p-6 bg-white rounded-xl shadow-sm border border-purple-200">
                    <h3 class="text-2xl font-bold text-black-800 mb-4">All Expense History</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-200 text-black-800 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Expense Name</th>
                                    <th class="py-3 px-6 text-left">Amount</th>
                                    <th class="py-3 px-6 text-left">Date</th>
                                    <th class="py-3 px-6 text-left">Quarter</th>
                                    <th class="py-3 px-6 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="all-expense-history-tbody" class="text-gray-700 text-lg font-medium">
                                </tbody>
                        </table>
                    </div>
                </div>
            `;
            dynamicContentArea.appendChild(dashboardContent);

            // --- Attach Event Listeners for Main Dashboard ---
            const annualIncomeInput = document.getElementById('annual-income');
            annualIncomeInput.addEventListener('input', handleIncomeChange);
            annualIncomeInput.addEventListener('blur', renderApp); // Re-render on blur
            annualIncomeInput.addEventListener('keydown', (e) => { // New: Re-render on Enter keydown
                if (e.key === 'Enter') {
                    renderApp();
                    e.preventDefault(); // Prevent default Enter key behavior (e.g., form submission)
                }
            });


            // Populate Quarter Grid
            const quarterGrid = document.getElementById('quarter-grid');
            const quarterIds = ['Q1', 'Q2', 'Q3', 'Q4'];
            const quarterPeriods = ['January-March', 'April-June', 'July-September', 'October-December'];

            quarterIds.forEach((quarterId, index) => {
                const quarterExpenses = recordedExpenses.filter(expense => expense.quarter === quarterId);
                const quarterTotalExpenses = quarterExpenses.reduce((sum, expense) => sum + expense.amount, 0);
                const quarterRemainingBalance = quarterlyBudget - quarterTotalExpenses;

                const percentageUsed = quarterlyBudget === 0
                    ? 0
                    : Math.min(100, (quarterTotalExpenses / quarterlyBudget) * 100);

                const quarterDiv = document.createElement('div');
                quarterDiv.className = 'bg-white p-5 rounded-lg shadow-md border border-gray-200 cursor-pointer hover:shadow-lg transition duration-200 ease-in-out transform hover:scale-105';
                quarterDiv.dataset.quarterId = quarterId; // Store quarter ID for click handler
                quarterDiv.innerHTML = `
                    <p class="text-lg font-semibold text-gray-800 mb-2">
                        Quarter ${index + 1}
                    </p>
                    <p class="text-sm text-gray-600 mb-3">
                        ${quarterPeriods[index]}
                    </p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2 relative">
                        <div
                            class="${quarterRemainingBalance >= 0 ? 'bg-green-500' : 'bg-red-500'} h-2.5 rounded-full flex items-center justify-center"
                            style="width: ${percentageUsed}%"
                        >
                            ${quarterlyBudget > 0 && percentageUsed > 0 ? `<span class="text-xs font-bold text-white leading-none px-1">${Math.round(percentageUsed)}%</span>` : ''}
                        </div>
                    </div>
                    <p class="text-xl font-bold text-right ${quarterRemainingBalance >= 0 ? 'text-green-700' : 'text-red-700'}">
                        Remaining: ${formatCurrency(quarterRemainingBalance)}
                    </p>
                `;
                quarterDiv.addEventListener('click', () => {
                    currentView = 'quarterDetails'; // Change view state
                    selectedQuarterId = quarterId; // Set selected quarter
                    renderApp();
                });
                quarterGrid.appendChild(quarterDiv);
            });

            // Populate All Expense History Table in the Main Dashboard
            const allExpenseHistoryTbody = document.getElementById('all-expense-history-tbody');
            if (recordedExpenses.length === 0) {
                allExpenseHistoryTbody.innerHTML = `
                    <tr>
                        <td colSpan="5" class="py-4 px-6 text-center text-gray-500">No expenses recorded yet.</td>
                    </tr>
                `;
            } else {
                allExpenseHistoryTbody.innerHTML = ''; // Clear existing
                recordedExpenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap">${expense.name}</td>
                        <td class="py-3 px-6 text-left whitespace-nowrap">${formatCurrency(expense.amount)}</td>
                        <td class="py-3 px-6 text-left whitespace-nowrap">${expense.date}</td>
                        <td class="py-3 px-6 text-left whitespace-nowrap">${expense.quarter || 'General'}</td>
                        <td class="py-3 px-6 text-center">
                            <button
                                class="remove-expense-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-sm"
                                data-id="${expense.id}"
                                aria-label="Remove ${expense.name}"
                            >
                                Remove
                            </button>
                        </td>
                    `;
                    allExpenseHistoryTbody.appendChild(row);
                });
                // Attach event listeners to newly created remove buttons
                allExpenseHistoryTbody.querySelectorAll('.remove-expense-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        handleRemoveExpense(parseInt(e.target.dataset.id));
                    });
                });
            }
        }

        /**
         * Renders the view for all expenses (Fund Dashboard).
         */
        function renderAllExpensesView() {
            const dynamicContentArea = document.getElementById('dynamic-content-area');
            dynamicContentArea.innerHTML = ''; // Clear existing content

            const allExpensesContent = document.createElement('div');
            allExpensesContent.className = 'max-w-full mx-auto bg-white p-6 rounded-lg shadow';
            allExpensesContent.innerHTML = `

                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto text-sm text-left border">
                        <thead class="bg-gray-200 text-black">
                            <tr>
                                <th class="px-4 py-2">Expense Item</th>
                                <th class="px-4 py-2">Account Code</th>
                                <th class="px-4 py-2">1st Quarter</th>
                                <th class="px-4 py-2">2nd Quarter</th>
                                <th class="px-4 py-2">3rd Quarter</th>
                                <th class="px-4 py-2">4th Quarter</th>
                                <th class="px-4 py-2">TOTAL</th>
                                <th class="px-4 py-2">Obligated</th>
                                <th class="px-4 py-2">Balance</th>
                                <th class="px-4 py-2">Status</th>
                                <th class="px-4 py-2 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="fund-table-tbody" class="text-gray-800">
                            </tbody>
                        <tfoot id="fund-table-tfoot" class="font-bold bg-yellow-100">
                            </tfoot>
                    </table>
                </div>

               <div class="mt-6 p-4 bg-white rounded-lg shadow-md">
    <div class="flex justify-center">
        <button id="add-row-btn" class="bg-gray-200 hover:bg-gray-300 text-black font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
            Add Row
        </button>
    </div>
</div>

            `;
            dynamicContentArea.appendChild(allExpensesContent);

            // Attach event listener for Add Row button
            document.getElementById('add-row-btn').addEventListener('click', addFundRow);

            // Populate the fund table
            const fundTableTbody = document.getElementById('fund-table-tbody');
            const fundTableTfoot = document.getElementById('fund-table-tfoot');

            let overallTotalQ1 = 0;
            let overallTotalQ2 = 0;
            let overallTotalQ3 = 0;
            let overallTotalQ4 = 0;
            let overallTotal = 0;
            let overallObligated = 0;
            let overallBalance = 0;

            fundData.forEach((rowData, index) => {
                // Ensure quarter values are numbers before summing
                const q1 = parseFloat(rowData.q1) || 0;
                const q2 = parseFloat(rowData.q2) || 0;
                const q3 = parseFloat(rowData.q3) || 0;
                const q4 = parseFloat(rowData.q4) || 0;
                const obligated = parseFloat(rowData.obligated) || 0;

                const rowTotal = q1 + q2 + q3 + q4;
                const rowBalance = rowTotal - obligated;

                overallTotalQ1 += q1;
                overallTotalQ2 += q2;
                overallTotalQ3 += q3;
                overallTotalQ4 += q4;
                overallTotal += rowTotal;
                overallObligated += obligated;
                overallBalance += rowBalance;

                const row = document.createElement('tr');
                row.className = `${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} border-b`;
                row.innerHTML = `
                    <td class="px-4 py-2" contenteditable="true" data-field="expenseItem" data-id="${rowData.id}">${rowData.expenseItem}</td>
                    <td class="px-4 py-2" contenteditable="true" data-field="accountCode" data-id="${rowData.id}" data-maxlength="20">${rowData.accountCode}</td>
                    <td class="px-4 py-2">
                        <input type="text" class="w-full bg-transparent border-none focus:outline-none" value="${rowData.q1}" data-field="q1" data-id="${rowData.id}">
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" class="w-full bg-transparent border-none focus:outline-none" value="${rowData.q2}" data-field="q2" data-id="${rowData.id}">
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" class="w-full bg-transparent border-none focus:outline-none" value="${rowData.q3}" data-field="q3" data-id="${rowData.id}">
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" class="w-full bg-transparent border-none focus:outline-none" value="${rowData.q4}" data-field="q4" data-id="${rowData.id}">
                    </td>
                    <td class="px-4 py-2 font-semibold">${formatCurrency(rowTotal)}</td>
                    <td class="px-4 py-2">
                        <input type="text" class="w-full bg-transparent border-none focus:outline-none" value="${rowData.obligated}" data-field="obligated" data-id="${rowData.id}">
                    </td>
                    <td class="px-4 py-2 font-semibold">${formatCurrency(rowBalance)}</td>
                    <td class="px-4 py-2">
                        <select class="w-full bg-transparent border-none focus:outline-none" data-field="status" data-id="${rowData.id}">
                            <option value="Not Utilized" ${rowData.status === 'Not Utilized' ? 'selected' : ''}>Not Utilized</option>
                            <option value="Under Utilization" ${rowData.status === 'Under Utilization' ? 'selected' : ''}>Under Utilization</option>
                            <option value="Utilized" ${rowData.status === 'Utilized' ? 'selected' : ''}>Utilized</option>
                        </select>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <button class="delete-row-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-lg text-xs" data-id="${rowData.id}">Delete</button>
                    </td>
                `;
                fundTableTbody.appendChild(row);
            });

            // Add overall total row
            fundTableTfoot.innerHTML = `
                <tr class="font-bold bg-yellow-100">
                    <td class="px-4 py-2 text-center" colspan="2">TOTAL</td>
                    <td class="px-4 py-2">${formatCurrency(overallTotalQ1)}</td>
                    <td class="px-4 py-2">${formatCurrency(overallTotalQ2)}</td>
                    <td class="px-4 py-2">${formatCurrency(overallTotalQ3)}</td>
                    <td class="px-4 py-2">${formatCurrency(overallTotalQ4)}</td>
                    <td class="px-4 py-2">${formatCurrency(overallTotal)}</td>
                    <td class="px-4 py-2">${formatCurrency(overallObligated)}</td>
                    <td class="px-4 py-2">${formatCurrency(overallBalance)}</td>
                    <td class="px-4 py-2"></td>
                    <td class="px-4 py-2"></td> <!-- Empty cell for the Action column in the footer -->
                </tr>
            `;

            // Attach event listeners for editable fields
            fundTableTbody.querySelectorAll('input[type="text"]').forEach(input => {
                // On 'input' event, update the data model immediately with the string value
                input.addEventListener('input', (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const field = e.target.dataset.field;
                    const value = e.target.value; // Get the raw string value
                    const index = fundData.findIndex(item => item.id === id);
                    if (index !== -1) {
                        // Validate input to allow only numbers and a single decimal point
                        if (/^\d*\.?\d*$/.test(value) || value === '') {
                            fundData[index][field] = value; // Store as string for typing flexibility
                        } else {
                            // If invalid, revert the input field to its previous valid state
                            e.target.value = fundData[index][field];
                        }
                    }
                });

                // On 'blur' (when input loses focus), parse to float and re-render
                input.addEventListener('blur', (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const field = e.target.dataset.field;
                    const value = parseFloat(e.target.value) || 0; // Parse to number on blur
                    const index = fundData.findIndex(item => item.id === id);
                    if (index !== -1) {
                        fundData[index][field] = value; // Store the numeric value
                        renderApp(); // Re-render the app to update calculations and display
                    }
                });

                // New: On 'keydown' event, if Enter is pressed, trigger blur and prevent default
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.target.blur(); // Trigger blur event
                        e.preventDefault(); // Prevent default Enter key behavior (e.g., form submission)
                    }
                });
            });

            fundTableTbody.querySelectorAll('[contenteditable="true"]').forEach(td => {
                td.addEventListener('blur', (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const field = e.target.dataset.field;
                    const value = e.target.textContent;
                    const index = fundData.findIndex(item => item.id === id);
                    if (index !== -1) {
                        fundData[index][field] = value;
                        renderApp(); // Re-render to update display if needed
                    }
                });
                // New: On 'keydown' event, if Enter is pressed, trigger blur and prevent default
                td.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.target.blur(); // Trigger blur event
                        e.preventDefault(); // Prevent default Enter key behavior (e.g., new line)
                    }
                    // Prevent new line on hyphen for accountCode and apply character limit
                    if (e.target.dataset.field === 'accountCode') {
                        const maxLength = parseInt(e.target.dataset.maxlength) || 20; // Default to 20
                        if (e.target.textContent.length >= maxLength && e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                            e.preventDefault(); // Prevent further input if max length reached
                        }
                    }
                });
            });

            fundTableTbody.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const field = e.target.dataset.field;
                    const value = e.target.value;
                    const index = fundData.findIndex(item => item.id === id);
                    if (index !== -1) {
                        fundData[index][field] = value;
                        renderApp(); // Re-render to update display
                    }
                });
            });

            // Attach event listeners for delete buttons
            fundTableTbody.querySelectorAll('.delete-row-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.target.dataset.id);
                    deleteFundRow(id);
                });
            });
        }

        /**
         * Main render function: decides which view to show and renders navigation.
         * This function is called whenever the application state changes.
         */
        function renderApp() {
            renderNavigation(); // Always render navigation first

            if (currentView === 'quarterDetails') {
                renderQuarterDetailsView(selectedQuarterId);
            } else if (currentView === 'allExpenses') {
                renderAllExpensesView();
            }
            else { // Default to dashboard
                renderMainDashboard();
            }
        }

        // --- Initial Render when the DOM is fully loaded ---
        document.addEventListener('DOMContentLoaded', renderApp);
    </script>
</body>
</html>
